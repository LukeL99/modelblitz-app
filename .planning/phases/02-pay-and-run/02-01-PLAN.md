---
phase: 02-pay-and-run
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/003_benchmark_runs.sql
  - src/lib/supabase/admin.ts
  - src/lib/stripe/client.ts
  - src/lib/stripe/config.ts
  - src/lib/debug/mock-config.ts
  - src/components/debug/mock-indicator.tsx
  - src/types/database.ts
  - src/lib/config/constants.ts
  - .env.local.example
  - src/app/api/checkout/route.ts
  - src/app/api/webhooks/stripe/route.ts
  - src/app/checkout/success/page.tsx
  - src/app/checkout/cancel/page.tsx
  - src/app/(app)/benchmark/[id]/processing/page.tsx
  - src/components/wizard/confirmation-screen.tsx
  - src/app/(app)/benchmark/new/page.tsx
  - src/app/layout.tsx
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing for $14.99 benchmark reports"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (use test key for development)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe CLI: run `stripe listen --forward-to localhost:3000/api/webhooks/stripe` and copy the webhook signing secret"
    dashboard_config:
      - task: "Install Stripe CLI for local webhook testing"
        location: "https://docs.stripe.com/stripe-cli"
  - service: openrouter
    why: "Vision model API calls for benchmarking"
    env_vars:
      - name: OPENROUTER_API_KEY
        source: "OpenRouter Dashboard -> Keys -> Create key"
  - service: resend
    why: "Transactional email for report completion notification"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"

must_haves:
  truths:
    - "Stripe Checkout session can be created from a ready draft"
    - "Stripe webhook receives checkout.session.completed and creates a report record idempotently"
    - "User sees confirmation screen with benchmark summary before Stripe redirect"
    - "User lands on processing page after successful payment"
    - "User sees cancel page with retry option on payment failure"
    - "Debug mock indicator appears when any mock env var is active"
    - "Mock Stripe mode skips redirect and immediately creates paid session"
  artifacts:
    - path: "supabase/migrations/003_benchmark_runs.sql"
      provides: "benchmark_runs table with per-run results and stripe_session_id on reports"
      contains: "CREATE TABLE benchmark_runs"
    - path: "src/lib/supabase/admin.ts"
      provides: "Service-role Supabase client for server operations without user session"
      exports: ["createAdminClient"]
    - path: "src/lib/stripe/client.ts"
      provides: "Stripe server SDK singleton"
      exports: ["stripe"]
    - path: "src/app/api/checkout/route.ts"
      provides: "POST endpoint to create Stripe Checkout session"
      exports: ["POST"]
    - path: "src/app/api/webhooks/stripe/route.ts"
      provides: "POST endpoint for Stripe webhook events"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/checkout/route.ts"
      to: "src/lib/stripe/client.ts"
      via: "stripe.checkout.sessions.create"
      pattern: "stripe\\.checkout\\.sessions\\.create"
    - from: "src/app/api/webhooks/stripe/route.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient for RLS-bypassed DB operations"
      pattern: "createAdminClient"
    - from: "src/app/api/webhooks/stripe/route.ts"
      to: "stripe.webhooks.constructEvent"
      via: "Signature verification with raw body"
      pattern: "request\\.text\\(\\)"
---

<objective>
Build Stripe payment infrastructure, database migration for benchmark runs, Supabase admin client, debug mock system, and the full checkout-to-processing page flow.

Purpose: Establishes the payment layer that converts a configured benchmark draft into a paid report record ready for engine execution. Includes mock infrastructure for development without real Stripe/OpenRouter/email services.

Output: Database migration, Stripe integration, webhook handler, checkout pages, debug mock system, and confirmation screen.
</objective>

<execution_context>
@/Users/lukelibraro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lukelibraro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pay-and-run/02-CONTEXT.md
@.planning/phases/02-pay-and-run/02-RESEARCH.md
@.planning/phases/01-configure-benchmark/01-01-SUMMARY.md
@.planning/phases/01-configure-benchmark/01-04-SUMMARY.md

Key existing files to reference:
@src/types/database.ts
@src/types/benchmark.ts
@src/lib/supabase/server.ts
@src/lib/supabase/queries.ts
@src/lib/config/constants.ts
@src/lib/config/models.ts
@src/app/(app)/benchmark/new/page.tsx
@src/app/(app)/layout.tsx
@.env.local.example
@supabase/migrations/001_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration, Supabase admin client, Stripe client, debug mock infrastructure, and extended types</name>
  <files>
    supabase/migrations/003_benchmark_runs.sql
    src/lib/supabase/admin.ts
    src/lib/stripe/client.ts
    src/lib/stripe/config.ts
    src/lib/debug/mock-config.ts
    src/components/debug/mock-indicator.tsx
    src/types/database.ts
    src/lib/config/constants.ts
    .env.local.example
    src/app/layout.tsx
  </files>
  <action>
    **1. Database migration (`supabase/migrations/003_benchmark_runs.sql`):**
    Create benchmark_runs table to store per-run results:
    ```sql
    CREATE TABLE benchmark_runs (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      report_id UUID NOT NULL REFERENCES reports(id) ON DELETE CASCADE,
      model_id TEXT NOT NULL,
      image_index INT NOT NULL,
      run_number INT NOT NULL,

      -- Results
      output_json JSONB,
      is_valid_json BOOLEAN DEFAULT false,
      exact_match BOOLEAN DEFAULT false,
      field_accuracy NUMERIC(5,2),
      field_errors JSONB DEFAULT '[]',

      -- Performance metrics
      response_time_ms INT,
      input_tokens INT,
      output_tokens INT,
      actual_cost NUMERIC(10,6),
      estimated_cost NUMERIC(10,6),

      -- Status
      status TEXT NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'running', 'complete', 'failed', 'skipped')),
      error_message TEXT,

      created_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );
    ```
    Add indexes: (report_id), (report_id, model_id), (status).
    Enable RLS. Add policies: authenticated users can SELECT runs where report.user_id = auth.uid() (join through reports table); service_role can do everything (implicit).
    Also add `stripe_session_id TEXT UNIQUE` column to reports table via ALTER TABLE.
    Add an UPDATE policy on reports for authenticated users (needed for status updates): `USING ((SELECT auth.uid()) = user_id)`.

    **2. Supabase admin client (`src/lib/supabase/admin.ts`):**
    Create service-role client that bypasses RLS. Server-only (no NEXT_PUBLIC_ prefix on the key).
    ```typescript
    import { createClient } from "@supabase/supabase-js";
    export function createAdminClient() {
      return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
      );
    }
    ```

    **3. Stripe client (`src/lib/stripe/client.ts`):**
    Singleton Stripe server SDK instance. Import from 'stripe'. Use process.env.STRIPE_SECRET_KEY. Set apiVersion to latest stable.
    When `process.env.DEBUG_MOCK_STRIPE === 'true'`, export a null stripe client (mock mode will bypass it).

    **4. Stripe config (`src/lib/stripe/config.ts`):**
    Export constants: STRIPE_WEBHOOK_SECRET from env, success/cancel URLs using NEXT_PUBLIC_SITE_URL.

    **5. Debug mock config (`src/lib/debug/mock-config.ts`):**
    Read environment variables to determine mock state:
    - `DEBUG_MOCK_STRIPE` (default: 'false')
    - `DEBUG_MOCK_OPENROUTER` (default: 'false')
    - `DEBUG_MOCK_EMAIL` (default: 'false')
    Export `isMockStripe()`, `isMockOpenRouter()`, `isMockEmail()`, and `getActiveMocks(): string[]` functions.
    Also export for client-side: `NEXT_PUBLIC_DEBUG_MOCKS` env var (comma-separated list of active mocks, set at build time).

    **6. Debug mock indicator (`src/components/debug/mock-indicator.tsx`):**
    Client component. Reads `process.env.NEXT_PUBLIC_DEBUG_MOCKS`. If empty/undefined, render nothing.
    Otherwise render a fixed-position bottom-left corner badge (small, unobtrusive) showing active mocks.
    Style: `fixed bottom-3 left-3 z-[9999]` with semi-transparent dark background, small text listing active mocks (e.g., "MOCK: stripe, openrouter"). Use amber/yellow color to stand out as a dev indicator.

    **7. Extend types (`src/types/database.ts`):**
    Add `BenchmarkRun` interface matching the new table columns. Add to Database interface Tables. Add stripe_session_id to Report interface.

    **8. Extend constants (`src/lib/config/constants.ts`):**
    Add: `HARD_COST_CEILING = 15.0` (absolute abort threshold), `INTERNAL_COST_BUFFER = 6.50` (reserve for in-flight calls), `PER_MODEL_CONCURRENCY = 3`, `GLOBAL_CONCURRENCY = 10`.

    **9. Update `.env.local.example`:**
    Add new env vars with comments:
    ```
    # Stripe (server-only)
    STRIPE_SECRET_KEY=sk_test_...
    STRIPE_WEBHOOK_SECRET=whsec_...
    SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

    # OpenRouter
    OPENROUTER_API_KEY=sk-or-...

    # Email (Resend)
    RESEND_API_KEY=re_...

    # Debug mocks (set to 'true' to enable)
    DEBUG_MOCK_STRIPE=false
    DEBUG_MOCK_OPENROUTER=false
    DEBUG_MOCK_EMAIL=false
    NEXT_PUBLIC_DEBUG_MOCKS=
    ```

    **10. Add mock indicator to root layout (`src/app/layout.tsx`):**
    Import MockIndicator and render it inside the body, after children. It self-hides when no mocks are active.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors
    - `npm run build` succeeds
    - New migration file exists at supabase/migrations/003_benchmark_runs.sql
    - `src/lib/supabase/admin.ts` exports createAdminClient
    - `src/lib/stripe/client.ts` exports stripe
    - `src/lib/debug/mock-config.ts` exports isMockStripe, isMockOpenRouter, isMockEmail, getActiveMocks
    - MockIndicator renders nothing when NEXT_PUBLIC_DEBUG_MOCKS is empty
  </verify>
  <done>
    Database migration defines benchmark_runs table with all per-run columns, Supabase admin client bypasses RLS for server operations, Stripe client singleton is configured, debug mock infrastructure is in place with visual indicator, types and constants are extended for Phase 2.
  </done>
</task>

<task type="auto">
  <name>Task 2: Checkout API route, Stripe webhook handler, confirmation screen, and checkout pages</name>
  <files>
    src/app/api/checkout/route.ts
    src/app/api/webhooks/stripe/route.ts
    src/app/checkout/success/page.tsx
    src/app/checkout/cancel/page.tsx
    src/app/(app)/benchmark/[id]/processing/page.tsx
    src/components/wizard/confirmation-screen.tsx
    src/app/(app)/benchmark/new/page.tsx
  </files>
  <action>
    **1. Confirmation screen component (`src/components/wizard/confirmation-screen.tsx`):**
    Client component. Props: `draftId: string`, `configData` (priorities, strategy, sampleCount), `selectedModels: string[]`, `onCancel: () => void`.
    Display summary card:
    - Number of models selected
    - Number of sample images
    - Strategy name
    - Priority ranking
    - Price: "$14.99" (bold, prominent)
    - "This is a one-time payment. You will receive a comprehensive benchmark report."
    - Two buttons: "Back to Edit" (secondary, calls onCancel) and "Pay $14.99" (primary, triggers checkout)

    On "Pay $14.99" click:
    - If `isMockStripe()` (check via NEXT_PUBLIC_DEBUG_MOCKS containing 'stripe'):
      - POST to `/api/checkout` with `{ draftId, mock: true }`
      - API returns `{ reportId }` instead of `{ url }`
      - Navigate to `/benchmark/${reportId}/processing`
    - Else:
      - POST to `/api/checkout` with `{ draftId }`
      - API returns `{ url }`
      - `window.location.href = url` to redirect to Stripe

    **2. Checkout API route (`src/app/api/checkout/route.ts`):**
    POST handler. Authenticate user via createClient + getUser.
    Load draft by draftId, verify: exists, belongs to user, status === 'ready'.

    If request body has `mock: true` AND `isMockStripe()`:
    - Use createAdminClient to create a report directly (simulating post-payment):
      - Snapshot draft data into report (config_snapshot, image_paths, extraction_prompt, json_schema from draft)
      - Set status to 'paid'
      - Generate a fake stripe_session_id: `mock_${nanoid()}`
      - Update draft status to 'paid'
    - Return `{ reportId: report.id }`

    Else (real Stripe):
    - Create Stripe Checkout session using stripe.checkout.sessions.create:
      - mode: 'payment'
      - customer_email: user.email
      - client_reference_id: draftId
      - metadata: { draft_id: draftId, user_id: user.id }
      - line_items: single item, $14.99 (1499 cents), product name "ModelPick Benchmark Report"
      - success_url: `${NEXT_PUBLIC_SITE_URL}/checkout/success?session_id={CHECKOUT_SESSION_ID}`
      - cancel_url: `${NEXT_PUBLIC_SITE_URL}/checkout/cancel?draft=${draftId}`
    - Return `{ url: session.url }`

    **3. Stripe webhook handler (`src/app/api/webhooks/stripe/route.ts`):**
    POST handler. CRITICAL: Use `request.text()` not `request.json()` for signature verification.
    Verify signature with `stripe.webhooks.constructEvent(body, signature, STRIPE_WEBHOOK_SECRET)`.
    On invalid signature, return 400.

    Handle `checkout.session.completed` event:
    - Extract draft_id and user_id from session.metadata
    - Idempotency check: SELECT from reports WHERE stripe_session_id = session.id. If exists, return 200 "Already processed".
    - Load draft from database
    - Create report record:
      - user_id, draft_id, stripe_session_id: session.id, status: 'paid'
      - config_snapshot: { config_data, upload_data, schema_data, selected_models } from draft
      - image_paths: from upload_data.images[].path
      - extraction_prompt: from schema_data.prompt
      - json_schema: schema_data.userSchema || schema_data.inferredSchema
    - Update draft status to 'paid'
    - Use `after()` from 'next/server' to defer benchmark execution:
      ```typescript
      after(async () => {
        const { runBenchmark } = await import("@/lib/benchmark/engine");
        await runBenchmark(report.id);
      });
      ```
      NOTE: engine.ts does not exist yet (Plan 02-03 creates it). The dynamic import will fail gracefully in the background if engine.ts is missing. This is intentional -- the webhook creates the report record correctly regardless.
    - Return 200 "OK"

    Export route config: `export const maxDuration = 10;` (webhook itself is fast, benchmark runs in after())

    **4. Success page (`src/app/checkout/success/page.tsx`):**
    Server component. Read `session_id` from searchParams.
    Use createClient to find the report with matching stripe_session_id.
    If found, redirect to `/benchmark/${report.id}/processing`.
    If not found (webhook hasn't processed yet), show brief "Setting up your benchmark..." with auto-refresh meta tag (refresh every 2 seconds). After 10 seconds of no report, show a message: "Your payment was received. Your benchmark will appear on your dashboard shortly." with link to /dashboard.

    **5. Cancel page (`src/app/checkout/cancel/page.tsx`):**
    Simple page (no auth required, outside (app) layout).
    Read `draft` from searchParams.
    Show: "Payment was cancelled" heading, brief message, and a "Try Again" button linking to `/benchmark/new?draft=${draftId}` (if draftId exists) or `/dashboard` (if not).
    Style with the existing dark-warm palette. Center on page similar to auth pages.

    **6. Processing page (`src/app/(app)/benchmark/[id]/processing/page.tsx`):**
    Server component inside (app) layout (requires auth).
    Load report by id from params. Verify it belongs to the current user.
    If report not found or wrong user, redirect to /dashboard.
    Show: "Your benchmark is running..." heading with a spinner animation (CSS-only, using Tailwind animate-spin on a circle border).
    Display: model count, image count from config_snapshot.
    Brief text: "This typically takes 2-5 minutes. You can close this page -- we'll email you when your report is ready."
    Phase 3 will replace this with live progress via Supabase Realtime.

    **7. Wire confirmation screen into wizard (`src/app/(app)/benchmark/new/page.tsx`):**
    After the wizard reaches 'ready' state (Step 3 completion), show the ConfirmationScreen component instead of / in addition to the current completion state. The confirmation screen's onCancel returns to the wizard editing state.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - POST `/api/checkout` with valid draft returns `{ url }` (or `{ reportId }` in mock mode)
    - Webhook handler at `/api/webhooks/stripe` validates signatures and creates report records
    - `/checkout/success?session_id=...` page renders
    - `/checkout/cancel` page renders with retry button
    - `/benchmark/[id]/processing` page renders with spinner
    - Confirmation screen shows in wizard after Step 3 completion
  </verify>
  <done>
    Complete Stripe checkout flow works end-to-end: user sees confirmation screen with benchmark summary and $14.99 price, clicks Pay, redirects to Stripe (or mock skips redirect), webhook creates report idempotently, user lands on processing page. Cancel page offers retry. Mock mode works without Stripe keys.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. Build: `npm run build` succeeds
3. Migration file has correct SQL syntax (benchmark_runs table, stripe_session_id column, RLS policies)
4. Admin client uses service_role key (not anon key)
5. Stripe client uses STRIPE_SECRET_KEY (not NEXT_PUBLIC_)
6. Webhook handler uses request.text() not request.json()
7. Webhook has idempotency check on stripe_session_id
8. Mock mode bypasses Stripe redirect entirely
9. Debug indicator only appears when mocks are active
10. All new routes are accessible at their expected paths
</verification>

<success_criteria>
- Database migration defines benchmark_runs table and extends reports table
- Stripe Checkout session creation works from a 'ready' draft
- Webhook handler processes checkout.session.completed idempotently
- Mock Stripe mode creates report directly without Stripe interaction
- Confirmation screen displays benchmark summary with $14.99 price
- Success page redirects to processing page
- Cancel page shows retry option
- Processing page shows "running" status with spinner
- Debug mock indicator renders when mocks are active, hidden otherwise
</success_criteria>

<output>
After completion, create `.planning/phases/02-pay-and-run/02-01-SUMMARY.md`
</output>
