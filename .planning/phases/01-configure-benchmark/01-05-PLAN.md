---
phase: 01-configure-benchmark
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/002_storage_policies.sql
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Authenticated users can upload images to the benchmark-images storage bucket with RLS enabled"
    - "Authenticated users can only access (read, update, delete) their own uploaded images"
    - "Upload flow in wizard Step 2 works end-to-end: signed URL generation, upload, thumbnail display, deletion"
  artifacts:
    - path: "supabase/migrations/002_storage_policies.sql"
      provides: "RLS policies for storage.objects on benchmark-images bucket"
      contains: "CREATE POLICY"
  key_links:
    - from: "supabase/migrations/002_storage_policies.sql"
      to: "storage.objects"
      via: "RLS policies for INSERT, SELECT, UPDATE, DELETE"
      pattern: "CREATE POLICY.*storage\\.objects"
    - from: "src/app/api/upload/signed-url/route.ts"
      to: "storage.objects INSERT policy"
      via: "createSignedUploadUrl path pattern matches policy folder check"
      pattern: "\\$\\{user\\.id\\}/\\$\\{draftId\\}"
---

<objective>
Fix the RLS blocker preventing image uploads to Supabase Storage.

Purpose: UAT test 7 failed with "new row violates row-level security policy" because no RLS policies exist on storage.objects for the benchmark-images bucket. The policies were designed in research (01-RESEARCH.md lines 903-912) but left as SQL comments and never added to a migration. This single gap blocks tests 7, 8, 9, and 10 -- the entire upload and wizard completion flow.

Output: A new migration file (002_storage_policies.sql) that the user runs in Supabase SQL Editor to unblock the upload flow.
</objective>

<execution_context>
@/Users/lukelibraro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lukelibraro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/rls-upload-blocker.md
@supabase/migrations/001_initial_schema.sql
@src/app/api/upload/signed-url/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage RLS policies migration</name>
  <files>supabase/migrations/002_storage_policies.sql</files>
  <action>
Create `supabase/migrations/002_storage_policies.sql` with the following SQL statements:

1. **Bucket creation (idempotent):** INSERT the benchmark-images bucket into storage.buckets with `public = true` and ON CONFLICT DO NOTHING. The bucket may already exist from manual dashboard creation -- this makes the migration safe to run regardless.

2. **INSERT policy** ("Users can upload own images"): On storage.objects FOR INSERT, TO authenticated, WITH CHECK that bucket_id = 'benchmark-images' AND the first folder segment matches the user's auth.uid(). Use `(storage.foldername(name))[1] = (SELECT auth.uid())::text` for the folder ownership check. This aligns with the upload path pattern `${user.id}/${draftId}/${nanoid()}.${ext}` in route.ts line 78.

3. **SELECT policy** ("Users can view own images"): On storage.objects FOR SELECT, TO authenticated, USING same bucket_id and folder ownership check. Required for getPublicUrl() calls in step-upload.tsx line 96.

4. **UPDATE policy** ("Users can update own images"): On storage.objects FOR UPDATE, TO authenticated, USING + WITH CHECK same conditions. Required for potential image overwrites.

5. **DELETE policy** ("Users can delete own images"): On storage.objects FOR DELETE, TO authenticated, USING same conditions. Required for the .remove() call in step-upload.tsx line 164.

Add a header comment explaining this migration fixes the missing storage RLS policies that were designed in research but not included in 001_initial_schema.sql.

Do NOT modify 001_initial_schema.sql -- this is a new migration file that supplements it.
  </action>
  <verify>
1. File exists at supabase/migrations/002_storage_policies.sql
2. File contains exactly 4 CREATE POLICY statements (INSERT, SELECT, UPDATE, DELETE)
3. All policies reference bucket_id = 'benchmark-images'
4. All policies use `(storage.foldername(name))[1] = (SELECT auth.uid())::text` for folder ownership
5. File contains idempotent bucket INSERT with ON CONFLICT DO NOTHING
6. `npm run build` still passes (migration is SQL only, no TS impact)
  </verify>
  <done>Migration file exists with all 4 storage RLS policies covering INSERT, SELECT, UPDATE, and DELETE operations scoped to authenticated users accessing their own folder in the benchmark-images bucket.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Apply migration and verify upload flow</name>
  <files>supabase/migrations/002_storage_policies.sql</files>
  <action>
Present the user with instructions to apply the migration and verify the upload flow. This is a human-verify checkpoint -- Claude cannot run SQL against the user's live Supabase instance.
  </action>
  <verify>
User confirms upload works by typing "approved" or reports remaining issues.
  </verify>
  <done>User has applied the migration to their Supabase project and confirmed that image upload in wizard Step 2 works without RLS errors.</done>
  <what-built>
A new migration file `supabase/migrations/002_storage_policies.sql` that adds the missing RLS policies for the benchmark-images storage bucket. This fixes the "new row violates row-level security policy" error from UAT test 7.
  </what-built>
  <how-to-verify>
1. Open your Supabase Dashboard -> SQL Editor
2. Copy the contents of `supabase/migrations/002_storage_policies.sql` and run it
3. Verify in Dashboard -> Authentication -> Policies that 4 new policies appear on storage.objects:
   - "Users can upload own images" (INSERT)
   - "Users can view own images" (SELECT)
   - "Users can update own images" (UPDATE)
   - "Users can delete own images" (DELETE)
4. Run `npm run dev` and navigate to /benchmark/new
5. Complete Step 1 (any config), proceed to Step 2
6. Drag-and-drop or select an image file (PNG/JPG)
7. Verify the image uploads successfully (thumbnail appears, no RLS error)
8. Enter valid JSON in the editor for the image
9. Verify you can delete the image (click remove/delete)
10. If all works, proceed to Step 3 to confirm the full wizard flow completes
  </how-to-verify>
  <resume-signal>Type "approved" if upload works, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
- supabase/migrations/002_storage_policies.sql exists and contains correct SQL
- All 4 CRUD policies are present for storage.objects
- Folder ownership pattern matches the upload path format from route.ts
- Build passes (no TypeScript changes, SQL-only fix)
- User confirms upload works with RLS enabled (checkpoint)
</verification>

<success_criteria>
1. Migration file creates all required storage RLS policies
2. User can upload images in wizard Step 2 without RLS errors
3. User can view uploaded image thumbnails
4. User can delete uploaded images
5. UAT tests 7-10 are unblocked
</success_criteria>

<output>
After completion, create `.planning/phases/01-configure-benchmark/01-05-SUMMARY.md`
</output>
